<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>JobBoard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --border: #e5e7eb;
            --ok: #0a7c4a;
            --err: #c62828;
            --muted: #666;
            --bg: #fafafa;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: var(--bg);
        }

        header {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

            header h1 {
                margin: 0;
                font-size: 20px;
            }

            header .status {
                margin-left: auto;
                font-size: 12px;
                color: #222;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            header .dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                display: inline-block;
            }

        .dot.ok {
            background: #16a34a;
        }

        .dot.warn {
            background: #f59e0b;
        }

        .dot.err {
            background: #ef4444;
        }

        main {
            max-width: 1100px;
            margin: 18px auto;
            padding: 0 16px 40px;
        }

        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(320px,1fr));
        }

        .card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
        }

            .card h3 {
                margin: 0 0 10px;
                font-size: 16px;
            }

        label {
            display: block;
            margin: 8px 0 4px;
            font-size: 14px;
        }

        input, textarea, button {
            width: 100%;
            padding: 9px 10px;
            font-size: 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            cursor: pointer;
            border-color: #c7ccd1;
            background: #0d6efd;
            color: #fff;
            border: 1px solid #0d6efd;
        }

            button.secondary {
                background: #eef2ff;
                color: #1e3a8a;
                border: 1px solid #c7d2fe;
            }

        ul {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        .muted {
            color: var(--muted);
            font-size: 12.5px;
        }

        .ok {
            color: var(--ok);
        }

        .err {
            color: var(--err);
            white-space: pre-wrap;
        }

        .job-item {
            cursor: pointer;
        }

            .job-item.active {
                font-weight: 600;
            }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toast {
            position: fixed;
            right: 14px;
            top: 14px;
            background: #111;
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12.5px;
            opacity: .95;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>
</head>
<body>
    <header>
        <h1>JobBoard</h1>
        <div class="status">
            <span id="connDot" class="dot err"></span>
            <span id="connText">Bağlı değil</span>
        </div>
    </header>

    <main>
        <div id="topInfo" class="muted" style="margin:6px 0 14px;">Bu sayfadan API’yi doğrudan kullanın. Canlı güncellemeler SignalR ile gelir.</div>

        <div class="grid">
            <div class="card">
                <h3>İş İlanları</h3>
                <div class="row">
                    <button class="secondary" onclick="loadJobs()">Yenile</button>
                </div>
                <ul id="jobs" class="muted"></ul>
                <div id="jobsInfo" class="muted"></div>
            </div>

            <div class="card">
                <h3>Yeni İş İlanı</h3>
                <label for="title">Başlık</label>
                <input id="title" placeholder="Örn: Junior .NET Developer" />
                <label for="desc">Açıklama</label>
                <textarea id="desc" placeholder="Kısa açıklama"></textarea>
                <div class="row">
                    <button onclick="createJob()">Oluştur</button>
                    <button class="secondary" onclick="clearCreateForm()">Temizle</button>
                </div>
                <div id="createJobMsg" class="muted"></div>
            </div>

            <div class="card">
                <h3>Başvuru Yap</h3>
                <label for="jobId">Job Id</label>
                <input id="jobId" type="number" placeholder="Örn: 1" />
                <label for="appName">Ad Soyad</label>
                <input id="appName" placeholder="Örn: Ali Veli" />
                <label for="appEmail">E‑posta</label>
                <input id="appEmail" placeholder="ali@example.com" />
                <div class="row">
                    <button onclick="apply()">Başvur</button>
                    <button class="secondary" onclick="clearApplyForm()">Temizle</button>
                </div>
                <div id="applyMsg" class="muted"></div>
            </div>

            <div class="card">
                <h3>Başvurular (Seçili İş)</h3>
                <div class="row">
                    <button class="secondary" onclick="loadApplications()">Yenile</button>
                </div>
                <div id="appsInfo" class="muted" style="margin-top:8px;">Henüz iş seçilmedi.</div>
                <ul id="applications" class="muted" style="margin-top:8px;"></ul>
            </div>
        </div>

        <div id="error" class="err" style="margin-top:12px;"></div>
    </main>

    <script>
        const api = ""; // aynı origin
        let selectedJobId = null;

        // --------------- Helpers ---------------
        function $(id) { return document.getElementById(id); }
        function showErr(msg) { $("error").textContent = msg; }
        function clearErr() { $("error").textContent = ""; }
        function toast(msg, kind = "info") {
            const t = document.createElement("div");
            t.className = "toast";
            t.textContent = msg;
            if (kind === "ok") t.style.background = "#0a7c4a";
            if (kind === "err") t.style.background = "#c62828";
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }
        function escapeHtml(str) {
            return String(str ?? "").replace(/[&<>"']/g, s => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
            })[s]);
        }

        // --------------- Jobs ---------------
        async function loadJobs() {
            clearErr();
            const ul = $("jobs");
            const info = $("jobsInfo");
            ul.innerHTML = "Yükleniyor...";
            info.textContent = "";
            try {
                const res = await fetch(api + "/api/Jobs");
                if (!res.ok) { ul.innerHTML = ""; showErr("Jobs alınamadı: " + res.status + " " + res.statusText); return; }
                const data = await res.json();
                ul.innerHTML = "";
                if (!Array.isArray(data) || data.length === 0) { info.textContent = "Kayıt yok."; return; }
                data.forEach(j => {
                    const li = document.createElement("li");
                    li.className = "job-item" + (selectedJobId === j.id ? " active" : "");
                    li.textContent = "#" + j.id + " — " + j.title;
                    li.onclick = () => selectJob(j.id);
                    ul.appendChild(li);
                });
            } catch (e) { ul.innerHTML = ""; showErr(e.message); }
        }

        async function createJob() {
            clearErr();
            $("createJobMsg").textContent = "";
            const title = $("title").value.trim();
            const description = $("desc").value.trim();
            if (!title || !description) { showErr("Başlık ve açıklama zorunlu."); return; }
            try {
                const res = await fetch(api + "/api/Jobs", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title, description })
                });
                if (!res.ok) { showErr("Job oluşturulamadı: " + res.status + " " + res.statusText); return; }
                $("createJobMsg").innerHTML = "<span class='ok'>Oluşturuldu.</span>";
                $("title").value = "";
                $("desc").value = "";
                // JobCreated olayı gelmezse fallback:
                setTimeout(() => { /* en geç */ loadJobs(); }, 800);
            } catch (e) { showErr(e.message); }
        }
        function clearCreateForm() { $("title").value = ""; $("desc").value = ""; $("createJobMsg").textContent = ""; }

        function selectJob(id) {
            selectedJobId = id;
            $("jobId").value = id;
            $("appsInfo").textContent = "Job #" + id + " başvuruları";
            document.querySelectorAll(".job-item").forEach(el => {
                el.classList.toggle("active", el.textContent.startsWith("#" + id));
            });
            loadApplications();
        }

        // --------------- Applications ---------------
        async function apply() {
            clearErr();
            $("applyMsg").textContent = "";
            const id = parseInt($("jobId").value, 10);
            const applicantName = $("appName").value.trim();
            const applicantEmail = $("appEmail").value.trim();
            if (!id || !applicantName || !applicantEmail) { showErr("Tüm alanlar zorunlu."); return; }
            try {
                const res = await fetch(api + `/api/Jobs/${id}/apply`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ applicantName, applicantEmail })
                });
                if (!res.ok) { showErr("Başvuru başarısız: " + res.status + " " + res.statusText); return; }
                $("applyMsg").innerHTML = "<span class='ok'>Başvuru alındı.</span>";
                $("appName").value = "";
                $("appEmail").value = "";
                // Event gelmezse en geç fallback:
                if (selectedJobId === id) setTimeout(loadApplications, 800);
            } catch (e) { showErr(e.message); }
        }
        function clearApplyForm() { $("appName").value = ""; $("appEmail").value = ""; $("applyMsg").textContent = ""; }

        async function loadApplications() {
            clearErr();
            let id = selectedJobId || parseInt($("jobId").value, 10);
            if (!id) { $("appsInfo").textContent = "İş seçiniz."; $("applications").innerHTML = ""; return; }
            $("appsInfo").textContent = "Job #" + id + " başvuruları";
            const ul = $("applications");
            ul.innerHTML = "Yükleniyor...";
            try {
                const res = await fetch(api + `/api/Jobs/${id}/applications`);
                if (!res.ok) {
                    ul.innerHTML = "";
                    if (res.status === 404) $("appsInfo").textContent = "Başvurular endpoint'i henüz eklenmemiş olabilir.";
                    else showErr("Başvurular alınamadı: " + res.status + " " + res.statusText);
                    return;
                }
                const data = await res.json();
                ul.innerHTML = "";
                if (!Array.isArray(data) || data.length === 0) { ul.innerHTML = "<span class='muted'>Başvuru yok.</span>"; return; }
                data.forEach(a => {
                    const li = document.createElement("li");
                    const name = escapeHtml(a.applicantName ?? a.ApplicantName);
                    const mail = escapeHtml(a.applicantEmail ?? a.ApplicantEmail);
                    li.innerHTML = `#${a.id ?? a.Id} — ${name} <span class="muted">(${mail})</span>`;
                    ul.appendChild(li);
                });
            } catch (e) { $("applications").innerHTML = ""; showErr(e.message); }
        }

        // --------------- SignalR (realtime) ---------------
        let connection;
        function setConnStatus(state) {
            const dot = $("connDot"), text = $("connText");
            if (state === "ok") { dot.className = "dot ok"; text.textContent = "Bağlı"; }
            else if (state === "warn") { dot.className = "dot warn"; text.textContent = "Yeniden bağlanıyor..."; }
            else { dot.className = "dot err"; text.textContent = "Bağlı değil"; }
        }

        async function startHub() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/jobs")
                .withAutomaticReconnect()
                .build();

            connection.onreconnecting(() => setConnStatus("warn"));
            connection.onreconnected(() => setConnStatus("ok"));
            connection.onclose(() => setConnStatus("err"));

            // JobCreated — server bu adı kullanmalı; güvenli tarafta kalmak için listeyi tazele
            connection.on("JobCreated", job => {
                setTimeout(loadJobs, 100); // küçük gecikme
                toast("Yeni ilan yayınlandı", "ok");
            });

            // Application event — isim uyuşmazlığına karşı iki ismi de dinle
            connection.on("JobApplicationCreated", app => handleAppEvent(app));
            connection.on("ApplicationCreated", app => handleAppEvent(app)); // mevcut server bu olabilir

            try {
                await connection.start();
                setConnStatus("ok");
            } catch (e) {
                setConnStatus("err");
                // 2 sn sonra tekrar dene
                setTimeout(startHub, 2000);
            }
        }

        function handleAppEvent(app) {
            // camelCase / PascalCase farkını tolere et
            const jobId = app?.jobId ?? app?.JobId;
            if (selectedJobId && jobId === selectedJobId) {
                setTimeout(loadApplications, 100);
                toast("Yeni başvuru alındı", "ok");
            }
        }

        // --------------- Init ---------------
        window.addEventListener("load", () => {
            loadJobs();
            startHub();
            // Elle jobId yazılırsa da başvuruları getir
            $("jobId").addEventListener("input", () => {
                const v = parseInt($("jobId").value, 10);
                selectedJobId = Number.isFinite(v) ? v : null;
                if (selectedJobId) { $("appsInfo").textContent = "Job #" + selectedJobId + " başvuruları"; loadApplications(); }
            });
        });
    </script>
</body>
</html>